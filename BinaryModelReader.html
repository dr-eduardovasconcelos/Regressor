<html>
    <head>
        <title>Binary Model Reader</title>
    </head>

    <body>
        <h1>welcome to the regressor bin file reader.</h1>
        <h2>This page will allow you to generate responses from the binary file 
        generated by Regressor.</h2>
        <h3>Select the file 'binary_coeficients.bin'</h3>
        <input type="file" id="file"/> 
        <button id="file-button">send</button>
        <br/>
        <small>If you have any question about Regressor or this page, please, contact me <br/>
        eduardo.vasconcelos@recife.ifpe.edu.br</small>
        <div id='fields'></div>

        <script>

            var variables = 0;
            var degree = 0;
            var columns = 0;
            var B ;

            function executeEquation() {
                let _result = 0;
                let A = [];

                for (let i = 0; i < variables; i++) {
                    if (isNaN(document.forms[0].elements[i].value)) {
                        alert("You entered an invalid value: " + document.forms[0].elements[i].value);
                        return;
                    }

                    A.push(document.forms[0].elements[i].value);
                   
                }
                
                _result = _equation(A);
                
                document.querySelector("#result").innerHTML = "<h3>last response: " + _result + "</h3>" + document.querySelector("#result").innerHTML;
                
                for(let i = 0; i < variables; i++){
                    document.forms[0].elements[i].value = A[i];
                }

            }

            function _equation(A) {
                let _result = B[0];

                for (let i = 1; i < columns; i++) {
                    let limit = (((Math.log(i) / Math.log(degree + 1))) | 0)+1;

                    let product = 1;
                    for (let j = 0; j < limit; j++) {
                        product *= Math.pow(A[j],((i/Math.pow(degree+1,j)) | 0) % (degree+1)|0) ;
                        
                    }
                    
                    _result += B[i]*product;
                }
                
                return _result;
            }

            document.querySelector("#file-button").addEventListener("click", function () {

                if (document.querySelector("#file").value == '') {
                    alert("incorrect path!");
                    return;
                }

                var file = document.querySelector("#file").files[0];

                var reader = new FileReader();

                reader.onload = function (e) {
                    let rawData = e.target.result;

                    const _variables = new DataView(rawData.slice(0, 4)).getInt32(0, true);
                    const _degree = new DataView(rawData.slice(4, 8)).getInt32(0, true);

                    const _columns = Math.pow(_degree + 1, _variables);

                    let _B = [];

                    for (let i = 0; i < _columns; i++) {
                        _B.push(new DataView(rawData.slice(8 * (i + 1), 8 * (i + 2))).getFloat64(0, true));
                    }

                    variables = _variables;
                    degree = _degree;
                    columns = _columns;

                    B = _B;

                    let nextPage = "<div id='nextPage'>";
                    nextPage += "<h1>Use the fields bellow to insert the predictors</h1>";
                    nextPage += "<form>";

                    for (let i = 0; i < variables; i++) {
                        nextPage += "Predictor A" + (i) + ": <input type='text' name='A" + (i) + "'/><br/>";
                    }
                    
                    nextPage += "<input type='button' onclick='executeEquation()' value='execute'/>";

                    nextPage += "</form></div>"
                    
                    nextPage += "<div id=\"result\"></div>";

                    document.querySelector("#fields").innerHTML = nextPage;

                }

                reader.onerror = function (e) {
                    alert("error on load file: " + e.type);
                }

                reader.readAsArrayBuffer(file);

            })

        </script>

    </body>
</html>
